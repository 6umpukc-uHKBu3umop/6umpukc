#!/usr/bin/env perl
use 5.016;
use warnings;
use FindBin qw($RealBin $Bin $Script);

sub is_mingw() {
    my $msystem = exists $ENV{'MSYSTEM'} ? $ENV{'MSYSTEM'} : '';
    if (($msystem eq 'MINGW64') or ($msystem eq 'MINGW32') or ($msystem eq 'MSYS')) {
        return 1;
    }
    return 0;
}

sub file_get_contents {
    my $filename = shift;
    my $result = '';
    if (open(my $fh, '<:encoding(UTF-8)', $filename)) {
        while (my $line = <$fh>) {
            $result .= $line;
        }
    }
    return $result;
}

sub file_put_contents {
    my $filename = shift;
    my $content = shift;
    if (open(my $fh, '>:encoding(UTF-8)', $filename)) {
        print $fh $content;
        close $fh;
        return 1;
    }
    return 0;
}

sub action_install {
    my $homeBin = $ENV{'HOME'} . '/bin';
    if (!-d $homeBin) {
        mkdir($homeBin);
    }

    if (is_mingw()) {
        my $fname = $ENV{'HOME'} . '/.bash_profile';
        my $initPath = 'PATH=$PATH:$HOME/bin/6umpukc';
        if (-f $fname) {
            my $content = file_get_contents($fname);
            if (index($content, $initPath) < 0) {
                file_put_contents($fname, $content . "\n" . $initPath . "\n");
            }
        }
        else {
            file_put_contents($fname, "\n" . $initPath . "\n");
        }
        return;
    }

    my $homeScript = $homeBin . '/' . $Script;
    if (-l $homeScript) {
        unlink($homeScript);
    }
    symlink($Bin . '/' . $Script, $homeScript);

    #TODO запрос пользователю - установить бинарник с гитхаба (если не качают то ставят dart-sdk самостоятельно или скачивают бинарник вручную)
}

if (defined($ARGV[0]) && ($ARGV[0] eq 'self-install')) {
    action_install();
}
else {
    my $args = join(' ', @ARGV);
    system "dart run '$RealBin/bx.dart' $args";
}


